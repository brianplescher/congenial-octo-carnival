<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Fiction Editor - Brian Plescher</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .password-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .password-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .editor-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .controls-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }
        
        .text-input textarea {
            width: 100%;
            min-height: 300px;
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
        }
        
        .paragraph-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            border-left: 4px solid #6366f1;
        }
        
        .paragraph-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .paragraph-content {
            padding: 1.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }
        
        .btn-accept { background: #10b981; color: white; }
        .btn-reject { background: #ef4444; color: white; }
        .btn-export { background: #6366f1; color: white; }
        .btn-small:hover { transform: translateY(-1px); }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .form-group select,
        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .processing { opacity: 0.7; pointer-events: none; }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        
        .analysis-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        
        @media (max-width: 1200px) {
            .editor-grid { grid-template-columns: 1fr; }
            .controls-panel { position: static; }
        }
    </style>
</head>
<body>
    <div id="passwordScreen" class="password-screen">
        <div class="password-form">
            <h1 style="margin-bottom: 1.5rem; text-align: center;">Editor Access</h1>
            <div class="form-group">
                <input type="password" id="passwordInput" placeholder="Enter password" />
            </div>
            <button onclick="checkPassword()" style="width: 100%; padding: 0.75rem; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Enter</button>
            <div id="passwordError" class="error-message">Incorrect password</div>
        </div>
    </div>

    <div id="editorInterface" style="display: none;">
        <nav style="background: white; padding: 1rem 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 1.25rem; font-weight: 600;">Historical Fiction Editor</div>
                <div>
                    <a href="index.html" style="margin-left: 1.5rem;">Home</a>
                    <a href="essays.html" style="margin-left: 1.5rem;">Essays</a>
                </div>
            </div>
        </nav>

        <div class="editor-container">
            <div class="editor-grid">
                <div class="controls-panel">
                    <h2 style="margin-top: 0;">Controls</h2>
                    
                    <div class="form-group">
                        <label for="chapterSelect">Chapter</label>
                        <select id="chapterSelect">
                            <option value="1">Chapter 1</option>
                            <option value="2">Chapter 2</option>
                            <option value="3">Chapter 3</option>
                            <option value="4">Chapter 4</option>
                            <option value="5">Chapter 5</option>
                            <option value="6">Chapter 6 (Keystone)</option>
                            <option value="7">Chapter 7</option>
                            <option value="8">Chapter 8</option>
                            <option value="9">Chapter 9</option>
                            <option value="10">Chapter 10</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="customContext">Additional Context</label>
                        <textarea id="customContext" rows="3" placeholder="Optional scene-specific guidance..."></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="deletionMode" style="width: auto; margin-right: 0.5rem;">
                            <span>Deletion Mode (tighten existing)</span>
                        </label>
                    </div>
                    
                    <div style="background: #e0e7ff; color: #3730a3; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem; border-left: 4px solid #6366f1;">
                        <strong>Status:</strong> Connected to Netlify Secure Function.
                    </div>
                    
                    <button onclick="processText()" id="processBtn" style="width: 100%; padding: 0.75rem; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 0.75rem;">
                        Process Text
                    </button>
                    
                    <button onclick="clearAllText()" style="width: 100%; padding: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        Clear All
                    </button>
                    
                    <div id="statusMessage"></div>
                </div>

                <div>
                    <div class="text-input" style="background: white; border-radius: 8px; box-shadow: 0 4px 24px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                        <textarea id="originalText" placeholder="Paste your text here (separate paragraphs with blank lines)..."></textarea>
                    </div>
                    
                    <div id="results"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let paragraphs = [];
        let processing = false;

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const correctPassword = 'stones'; 
            
            if (input === correctPassword) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('editorInterface').style.display = 'block';
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        function splitIntoParagraphs(text) {
            return text.split(/\n\n+/).map(p => p.trim()).filter(p => p);
        }

        async function processText() {
            const originalText = document.getElementById('originalText').value.trim();
            if (!originalText) {
                showStatus('Please enter text to process.', 'error');
                return;
            }

            const chapter = document.getElementById('chapterSelect').value;
            const deletionMode = document.getElementById('deletionMode').checked;
            const customContext = document.getElementById('customContext').value;

            processing = true;
            document.getElementById('processBtn').textContent = 'Processing...';
            document.getElementById('processBtn').disabled = true;

            try {
                paragraphs = splitIntoParagraphs(originalText).map((text, index) => ({
                    id: index,
                    original: text,
                    edited: null,
                    analysis: null,
                    status: 'pending'
                }));

                renderResults();
                
                for (let i = 0; i < paragraphs.length; i++) {
                    await processOneParagraph(i, chapter, deletionMode, customContext);
                }

                showStatus('Processing complete!', 'success');
            } catch (error) {
                console.error('Processing error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                processing = false;
                document.getElementById('processBtn').textContent = 'Process Text';
                document.getElementById('processBtn').disabled = false;
            }
        }

        // --- UPDATED FUNCTION FOR NETLIFY ---
        async function processOneParagraph(index, chapter, deletionMode, customContext) {
            const paragraph = paragraphs[index];
            renderResults();

            try {
                // Get API key (ask once and store for session)
                if (!window.claudeApiKey) {
                    window.claudeApiKey = prompt('Enter your Claude API key:');
                    if (!window.claudeApiKey) {
                        throw new Error('API key required');
                    }
                }

                const systemPrompt = generateSystemPrompt(parseInt(chapter), deletionMode, customContext);
                
                console.log('Making request via Netlify Function...');
                
                // CALLING THE SERVERLESS FUNCTION
                const response = await fetch('/api/anthropic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: window.claudeApiKey,
                        systemPrompt: systemPrompt,
                        userContent: `ORIGINAL PARAGRAPH:\n${paragraph.original}`
                    })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    throw new Error(`API error ${response.status}: ${errorText}`);
                }

                const claudeData = await response.json();
                
                // Handle provider errors wrapped in 200s
                if (claudeData.error) {
                    throw new Error(claudeData.error.message || JSON.stringify(claudeData.error));
                }

                const content = claudeData.content[0].text;

                // Parse Claude response
                const analysisMatch = content.match(/ANALYSIS:\s*(.+?)(?=\n\nREWRITE:)/s);
                const rewriteMatch = content.match(/REWRITE:\s*(.+)/s);

                const analysis = analysisMatch ? analysisMatch[1].trim() : 'Analysis not available';
                const editedText = rewriteMatch ? rewriteMatch[1].trim() : paragraph.original;

                paragraph.edited = editedText;
                paragraph.analysis = analysis;
                paragraph.status = 'completed';
                
            } catch (error) {
                console.error('Full error details:', error);
                paragraph.error = error.message;
                
                if (error.message.includes('authentication') || error.message.includes('401')) {
                    paragraph.error = 'Invalid API key. Please refresh and try again.';
                    window.claudeApiKey = null; 
                }
                
                paragraph.status = 'error';
            }
            
            renderResults();
        }

        // Helper function for system prompt generation
        function generateSystemPrompt(chapter, deletionMode = false, customContext = '') {
            const techniques = {
                1: { MW: 1, NH: 2, TC: 1, SAP: 3 },
                2: { NH: 3, SAP: 2 },
                3: { MW: 3, NH: 1, SAP: 2 },
                4: { PP: 3, TC: 3 },
                5: { PP: 1, AK: 3, TC: 1 },
                6: { MW: 3, PP: 3, NH: 3, AK: 1, TC: 3, SAP: 3 },
                7: { AK: 3, LO: 3, SAP: 1 },
                8: { MW: 1, PP: 2, NH: 3, TC: 1 },
                9: { MW: 2, NH: 1, AK: 2, LO: 2 },
                10: { MW: 2, PP: 1, TC: 2, LO: 2, SAP: 2 }
            };

            const plotFunctions = {
                1: "Entry/Threshold — narrator enters charged landscape, movement through space, first sensory anchor contact, no inciting incident",
                2: "Orientation Through Absence — world explained by what's missing, gaps in records/maps, authority encountered indirectly",
                3: "Pattern Emergence — repetition reveals structure, objects recur, spaces revisited, quiet recognition through accumulation",
                4: "Compression — pressure replaces progression, tasks accelerate, interior/exterior collapse, shift from observation to occupation",
                5: "Fracture — narrative coherence fails, bodily strain/breakdown, contradictory sequences, crisis not climax",
                6: "The Grinding Stones (KEYSTONE) — past and present fully coexist, historical labor intrudes bodily, possession not memory, structural center",
                7: "Human Labor — meaning enacted not interpreted, sustained physical work, exhaustion replaces insight, rebuilds through body",
                8: "Recognition Without Resolution — understanding arrives but solves nothing, awareness sharpens, no action follows, refuses catharsis",
                9: "Reverberation — consequences unfold quietly, small gestures, spaces register what occurred, aftermath without spectacle",
                10: "Integration/Exit — return to threshold, sensory anchor reappears altered, closure through recontextualization not resolution"
            };

            const forbidden = {
                1: "No backstory. No motivation statements. No explanation of arrival.",
                2: "No historical exposition. No corrective narration. No filling gaps.",
                3: "No symbolic interpretation of objects. No thematic summary.",
                4: "No pauses for reflection. No clarifying transitions.",
                5: "No repair of coherence. No emotional resolution.",
                6: "No dates. No named historical explanations. No interpretive framing of stones.",
                7: "No metaphorical labor. No insight following work. No abstraction.",
                8: "No decisions. No actions taken. No moral resolution.",
                9: "No dramatization of aftermath. No explicit consequence statements.",
                10: "No summative explanation. No meaning statements. No closure language."
            };

            const chapterTechniques = techniques[chapter] || {};
            const plotFunction = plotFunctions[chapter] || '';
            const chapterForbidden = forbidden[chapter] || '';

            let prompt = `You are editing historical fiction using canonical experimental techniques. Your edits must be surgical and authoritative.

CHAPTER ${chapter} ARCHITECTURE:
${plotFunction}

TECHNIQUES FOR THIS CHAPTER:`;

            const dominant = [];
            const active = [];
            const present = [];

            Object.entries(chapterTechniques).forEach(([code, level]) => {
                const names = {
                    MW: 'Material Witness',
                    PP: 'Polyphonic Possession',
                    NH: 'Negative Historiography',
                    AK: 'Abjection as Knowledge',
                    TC: 'Temporal Collapse',
                    LO: 'Labor as Ontology',
                    SAP: 'Sensory Anchor Portal'
                };
                const name = names[code];
                if (level === 3) dominant.push(name);
                else if (level === 2) active.push(name);
                else if (level === 1) present.push(name);
            });

            if (dominant.length) prompt += `\nDOMINANT (primary): ${dominant.join(', ')}`;
            if (active.length) prompt += `\nACTIVE (strong): ${active.join(', ')}`;
            if (present.length) prompt += `\nPRESENT (subtle): ${present.join(', ')}`;

            prompt += `

TECHNIQUE DEFINITIONS:
• Material Witness: Objects testify through wear/damage/persistence, NOT symbolism. NO interpretation.
• Polyphonic Possession: Multiple consciousnesses inhabit narrator without quotation marks/framing. NO reflection on possession.
• Negative Historiography: Meaning from gaps/erasure/missing docs. Name what's absent, don't fill it. NO exposition.
• Abjection as Knowledge: Understanding through bodily degradation. Sensation BEFORE thought. NO aestheticizing.
• Temporal Collapse: Multiple times in same sentence, no hierarchy. NO clear before/after. NO flashback framing.
• Labor as Ontology: Identity through repetitive physical work. Thought FROM action. NO metaphorical labor.
• Sensory Anchor Portal: Concrete sensation opens temporal layers involuntarily. NO "I remembered." NO explanation.

CRITICAL PRINCIPLE:
This plot is TECTONIC not DRAMATIC. Pressure replaces conflict. Contact replaces climax. Reverberation replaces resolution.
Do not add false drama. Do not create conflict where pressure suffices.

FORBIDDEN IN THIS CHAPTER:
${chapterForbidden}`;

            if (deletionMode) {
                prompt += `

DELETION MODE ACTIVE:
If paragraph already conforms, improve by REMOVING excess explanation, softening emphasis, tightening sentences.
Do not add imagery or insight unless structurally necessary.`;
            }

            if (customContext) {
                prompt += `

ADDITIONAL CONTEXT:
${customContext}`;
            }

            prompt += `

OUTPUT FORMAT:
Provide exactly two sections:
ANALYSIS: (2-3 sentences only) What works, what needs adjustment, what failure modes to avoid
REWRITE: (the edited paragraph, no preamble, just the prose)`;

            return prompt;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderResults() {
            const resultsDiv = document.getElementById('results');
            
            if (paragraphs.length === 0) {
                resultsDiv.innerHTML = '';
                return;
            }

            resultsDiv.innerHTML = paragraphs.map((p, i) => `
                <div class="paragraph-card ${p.status}">
                    <div class="paragraph-header">
                        <span><strong>Paragraph ${i + 1}</strong></span>
                        <div>
                            ${p.status === 'completed' ? `
                                <button class="btn-small btn-accept" onclick="acceptParagraph(${i})">Accept</button>
                                <button class="btn-small btn-reject" onclick="rejectParagraph(${i})">Reject</button>
                                <button class="btn-small btn-export" onclick="exportParagraph(${i})">Copy</button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="paragraph-content">
                        ${p.analysis ? `<div class="analysis-box"><strong>Analysis:</strong> ${escapeHtml(p.analysis)}</div>` : ''}
                        <div style="margin-bottom: 1.5rem;">
                            <strong>Original:</strong>
                            <p style="margin-top: 0.5rem; color: #6b7280;">${escapeHtml(p.original)}</p>
                        </div>
                        ${p.edited ? `
                            <div>
                                <strong>Edited:</strong>
                                <p style="margin-top: 0.5rem;">${escapeHtml(p.edited)}</p>
                            </div>
                        ` : p.status === 'pending' ? `
                            <div style="color: #6b7280; font-style: italic;">Waiting...</div>
                        ` : p.status === 'error' ? `
                            <div class="error-message">Error: ${escapeHtml(p.error || 'Unknown error')}</div>
                        ` : `
                            <div style="color: #6366f1; font-style: italic;">Processing...</div>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = type === 'error' ? 'error-message' : 'success-message';
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 5000);
            
            console.log(`Status (${type}):`, message);
        }

        function clearAllText() {
            if (confirm('Clear all text and results?')) {
                document.getElementById('originalText').value = '';
                paragraphs = [];
                renderResults();
            }
        }

        function acceptParagraph(i) {
            paragraphs[i].status = 'accepted';
            renderResults();
        }

        function rejectParagraph(i) {
            paragraphs[i].status = 'rejected';
            renderResults();
        }

        function exportParagraph(i) {
            const text = paragraphs[i].edited || paragraphs[i].original;
            navigator.clipboard.writeText(text).then(() => {
                showStatus('Copied to clipboard!', 'success');
            });
        }

        // Initialize
        document.getElementById('passwordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
    </script>
</body>
</html>